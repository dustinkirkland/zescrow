<?php
/*

    keyescrow: web application for securely escrowing keys
    - retrieve/download/index.html: download a retrieved deposit

    Copyright (C) 2008-2011 Scot-Irish Lads, LLC
    Author: Dustin Kirkland <dustin.kirkland@gmail.com>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, version 3 of the
    License.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

$TITLE = "Retrieve a deposit";
include("../../include/above.html");
?>

<p><b>You have the following deposits available for download:</b></p><br>

<form method="post" action="go/">
<table width="600">
  <tr>
    <th>Date of Deposit</th>
    <th>File name</th>
    <th>File size</th>
    <th>Text</th>
    <th></th>
  </tr>
<?php
$resultset = pg_query($CONN, "
	delete from
		retrieval
	where
		now() > expiration;
	delete from
		download
	where
		now() > expiration;
");
$resultset = pg_query($CONN, "
	select
		payload.id as id,
		payload.creation as uploaded,
		payload.note as note,
		payload.filesize as filesize,
		payload.filename as filename
	from
		retrieval,
		payload
	where
		retrieval.key='" . pg_escape_string($_REQUEST["key"]) . "'
		and
		payload.email=retrieval.email
");
for ($i=0; $i<pg_num_rows($resultset); $i++) {
	$result = pg_fetch_object($resultset, $i);
	$key = genkey();
	pg_query($CONN, "
		insert into
			download
		(
			payload_id,
			key
		)
		values
		(
			'" . $result->id . "',
			'" . $key . "'
		)
	");
	print("
  <tr>
    <td>" . preg_replace("/\..*$/", "", $result->uploaded) . "</td>
    <td>" . $result->filename . "</td>
	");
	if ($result->filesize > 0) {
		print("<td>" . $result->filesize . " bytes</td>");
	} else {
		print("<td></td>");
	}
	print("<td>" . $result->note . "</td>");
	if ($result->filesize > 0) {
		print("<td align=center><a href=go?key=$key><img src=../../include/disk.png></a></td>");
	} else {
		print("<td></td></tr>");
	}
}
for ($i=0; $i<pg_num_rows($resultset); $i++) {
	$result = pg_fetch_object($resultset, $i);
}
?>
</table>
</form>

<?php include("../../include/below.html"); ?>
