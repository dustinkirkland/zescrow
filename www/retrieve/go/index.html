<?php
/*

    keyescrow: web application for securely escrowing keys
    - retrieve/go/index.html: retrieve a deposit

    Copyright (C) 2008-2011 Scot-Irish Lads, LLC
    Author: Dustin Kirkland <dustin.kirkland@gmail.com>

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, version 3 of the
    License.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.

*/

$TITLE = "";
session_start();
$_SESSION["email"] = strtolower(urldecode($_SESSION["email"]));
include("../../include/above.html");

$resultset = pg_query($CONN, "
	select
		id
	from
		payload
	where
		email='" . pg_escape_string($_SESSION["email"]) . "'
");

if (pg_num_rows($resultset) >= 1) {
	$key = genkey();
	$resultset = pg_query($CONN, "
		insert into
			retrieval
		(
			email,
			key
		)
		values
		(
			'" . pg_escape_string($_SESSION["email"]) . "',
			'" . $key . "'
		)
	");
	$body = "

<pre>
To access your deposit(s), see:
	<a href='$URL/retrieve/download/?key=$key'>$URL/retrieve/download/?key=$key</a>
</pre>

";
	mailer($_SESSION["email"], $key);
	print("<center>Access instructions have been emailed to [" . $_SESSION["email"] . "]</center>");
} else {
	error("No deposits were found");
}

include("../../include/below.html");
?>
