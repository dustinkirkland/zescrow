# Install Ubuntu

# Install addtional packages
sudo apt-get install byobu bzr apache2 libapache2-mod-php5 postgresql php5-pgsql etckeeper ccze dkim-filter famfamfam-silk php-pear php5-dev libcurl3-openssl-dev libgpgme11 libgpgme11-dev
sudo pecl install gnupg
# You should add "extension=gnupg.so" to /etc/php5/apache2/php.ini

# Branch code
cd /srv
sudo bzr branch lp:zescrow zEscrow
sudo mv /var/www/ /var/www.orig

# Configure apache, enable site
sudo a2dissite default
sudo cp /srv/zEscrow/etc/apache_config.CHANGE_ME /etc/apache2/sites-available/zEscrow
sudo a2ensite zEscrow
sudo a2enmod ssl
sudo a2enmod rewrite
sudo service apache2 restart

# Create database
pw=$(pwgen -s 30 | head -n1)
sudo su - postgres -c "createdb zEscrow && psql -f /srv/zEscrow/db/schema.sql zEscrow"
sudo su - postgres -c "psql -c \"alter user postgres with password '$pw'\" zEscrow"
sudo cp /srv/zEscrow/www/include/credentials.html.CHANGE_ME /srv/zEscrow/www/include/credentials.html
sudo chmod 640 /srv/zEscrow/www/include/credentials.html
sudo chown root:www-data /srv/zEscrow/www/include/credentials.html
sudo sed -i "s/___password___/$pw/g" /srv/zEscrow/www/include/credentials.html
